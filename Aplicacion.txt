// src/Aplicacion.tsx
import React, { useState, useCallback, useMemo, useEffect } from 'react';
import { ProjectInfo, Invoice, Phase, HistoryEntry } from './types';
import ProjectSetup from './components/ProjectSetup';
import Header from './components/Header';
import InvoiceUploader from './components/InvoiceUploader';
import InvoicesTable from './components/InvoicesTable';
import { extractInvoiceData } from './services/geminiService';
import InvoiceViewerModal from './components/InvoiceViewerModal';
import PhaseManager from './components/PhaseManager';
import SummaryReportModal from './components/SummaryReportModal';
import HistoryLogModal from './components/HistoryLogModal';
import ChatHistoryModal from './components/ChatHistoryModal';
import EditInvoiceModal from './components/EditInvoiceModal';
import RegistrationModal from './components/RegistrationModal'; // ← IMPORTANTE

// Hook personalizado para manejar el estado que persiste en localStorage.
function usePersistentState<T>(key: string, initialValue: T): [T, React.Dispatch<React.SetStateAction<T>>] {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(`Error reading localStorage key “${key}”:`, error);
      return initialValue;
    }
  });

  const setValue: React.Dispatch<React.SetStateAction<T>> = useCallback((value) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value;
      setStoredValue(valueToStore);
      window.localStorage.setItem(key, JSON.stringify(valueToStore));
    } catch (error) {
      console.error(`Error setting localStorage key “${key}”:`, error);
    }
  }, [key, storedValue]);

  return [storedValue, setValue];
}

const App: React.FC = () => {
  // --- NUEVO ESTADO DE REGISTRO ---
  const [isRegistered, setIsRegistered] = useState<boolean>(() => {
    return window.localStorage.getItem('gastos_app_registered') === 'true';
  });

  const [projectInfo, setProjectInfo] = usePersistentState<ProjectInfo | null>('project-info', null);
  const [invoices, setInvoices] = usePersistentState<Invoice[]>('project-invoices', []);
  const [phases, setPhases] = usePersistentState<Phase[]>('project-phases', []);
  const [history, setHistory] = usePersistentState<HistoryEntry[]>('project-history', []);
  
  const [activePhaseId, setActivePhaseId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<{ message: string; duplicateInvoiceId?: string } | null>(null);
  const [selectedInvoice, setSelectedInvoice] = useState<Invoice | null>(null);
  const [isSummaryVisible, setIsSummaryVisible] = useState<boolean>(false);
  const [isHistoryVisible, setIsHistoryVisible] = useState<boolean>(false);
  const [isChatHistoryVisible, setIsChatHistoryVisible] = useState<boolean>(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterDate, setFilterDate] = useState('');
  
  const [isDebugLogVisible, setIsDebugLogVisible] = useState<boolean>(false);
  const [debugLog, setDebugLog] = useState<string[]>(['Log de depuración iniciado.']);
  const [editingInvoice, setEditingInvoice] = useState<Invoice | null>(null);

  // Funciones de utilidad
  const addDebugLog = useCallback((message: string) => {
    const timestamp = new Date().toLocaleTimeString('es-VE');
    setDebugLog(prev => {
      const newLog = [`[${timestamp}] ${message}`, ...prev];
      if (newLog.length > 100) newLog.pop();
      return newLog;
    });
  }, []);

  const addHistoryEntry = useCallback((message: string, type: HistoryEntry['type']) => {
    const newEntry: HistoryEntry = {
      id: new Date().toISOString() + Math.random(),
      timestamp: new Date().toISOString(),
      message,
      type,
    };
    setHistory(prev => [newEntry, ...prev]);
  }, [setHistory]);

  // Handlers
  const handleProjectSetup = (info: ProjectInfo) => {
    setProjectInfo(info);
    addHistoryEntry(`Proyecto "${info.communityName}" iniciado.`, 'project');
  };
  
  const handleResetProject = () => {
    if (window.confirm("¿Estás seguro de que quieres reiniciar? Se borrarán todos los datos.")) {
      setProjectInfo(null);
      setInvoices([]);
      setPhases([]);
      setHistory([]);
    }
  };

  const handleFileUpload = useCallback(async (file: File) => {
    setIsLoading(true);
    setError(null);
    try {
      const extractedData = await extractInvoiceData(file);
      // ... (tu lógica de extracción y duplicados permanece igual)
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onloadend = () => {
        const newInvoice: Invoice = {
          ...extractedData,
          id: new Date().toISOString() + Math.random(),
          fileDataUrl: reader.result as string,
          fileType: file.type,
          fileName: file.name,
        };
        setInvoices(prev => [newInvoice, ...prev]);
        setIsLoading(false);
      };
    } catch (err) {
      setError({ message: (err as Error).message });
      setIsLoading(false);
    }
  }, [invoices, setInvoices]);

  // --- LÓGICA DE RENDERIZADO CONDICIONAL ---

  // 1. Si NO está registrado, mostrar el modal de registro primero
  if (!isRegistered) {
    return (
      <RegistrationModal 
        registrationLink="https://forms.gle/TU_ID_DE_FORMULARIO" // Reemplaza con tu link real
        onComplete={() => setIsRegistered(true)} 
      />
    );
  }

  // 2. Si está registrado pero no hay proyecto, mostrar setup
  if (!projectInfo) {
    return <ProjectSetup onProjectSubmit={handleProjectSetup} />;
  }

  // 3. Si todo está listo, mostrar la aplicación principal
  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
      <Header 
        projectInfo={projectInfo} 
        onShowSummary={() => setIsSummaryVisible(true)}
        onShowHistory={() => setIsHistoryVisible(true)}
        onShowChatHistory={() => setIsChatHistoryVisible(true)}
        onResetProject={handleResetProject} 
      />
      <main className="container mx-auto p-4 md:p-8">
        <PhaseManager
            phases={phases}
            activePhaseId={activePhaseId}
            onSelectPhase={setActivePhaseId}
            onAddPhase={(name) => {
                const newPhase = { id: Date.now().toString(), name };
                setPhases([...phases, newPhase]);
            }}
        />

        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
          <InvoiceUploader 
            onFileUpload={handleFileUpload} 
            isLoading={isLoading}
            error={error}
            onErrorDismiss={() => setError(null)}
          />
        </div>
        
        <InvoicesTable 
            invoices={filteredInvoices}
            phases={phases}
            onView={(inv) => setSelectedInvoice(inv)} 
            onDelete={(id) => setInvoices(invoices.filter(i => i.id !== id))}
            onUpdateInvoicePhase={(invId, pId) => {
                setInvoices(invoices.map(i => i.id === invId ? {...i, phaseId: pId} : i));
            }}
            onEdit={setEditingInvoice}
            totalAmount={totalAmount}
            searchTerm={searchTerm}
            onSearchTermChange={setSearchTerm}
            filterDate={filterDate}
            onFilterDateChange={setFilterDate}
        />
      </main>
      
      {/* Modales adicionales */}
      {selectedInvoice && <InvoiceViewerModal invoice={selectedInvoice} onClose={() => setSelectedInvoice(null)} />}
      {editingInvoice && <EditInvoiceModal invoice={editingInvoice} onSave={(upd) => setInvoices(invoices.map(i => i.id === upd.id ? upd : i))} onClose={() => setEditingInvoice(null)} />}
      {isSummaryVisible && <SummaryReportModal projectInfo={projectInfo} invoices={invoices} phases={phases} onClose={() => setIsSummaryVisible(false)} />}
      {isHistoryVisible && <HistoryLogModal history={history} onClose={() => setIsHistoryVisible(false)} />}
      {isChatHistoryVisible && <ChatHistoryModal onClose={() => setIsChatHistoryVisible(false)} />}
    </div>
  );
};

export default App;